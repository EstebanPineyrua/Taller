const express = require("express");
const { ThermalPrinter, PrinterTypes } = require("node-thermal-printer");

const app = express();
app.use(express.json());

app.post("/imprimir", async (req,res)=>{
  const o = req.body;

  const printer = new ThermalPrinter({
    type: PrinterTypes.EPSON,
    interface: "usb",
    options:{ timeout:5000 }
  });

  try{
    for(let copia=1; copia<=2; copia++){
      printer.alignCenter();
      printer.setTextSize(1,1);
      printer.println("TALLER XYZ");
      printer.drawLine();

      printer.alignLeft();
      printer.println(`ORDEN #${o.id}`);
      printer.println(`Cliente: ${o.cliente}`);
      printer.println(`Equipo : ${o.equipo}`);
      printer.drawLine();

      printer.println("Falla:");
      printer.println(o.falla || "-");
      printer.drawLine();

      printer.println(`Estado: ${o.estado.toUpperCase()}`);
      printer.newLine();

      printer.alignCenter();
      printer.printQR(`ORDEN:${o.id}`, { cellSize:6 });
      printer.newLine();

      printer.println(`${o.fechaId} ${o.hora}`);
      printer.println("Gracias por su visita");
      printer.cut();
    }

    await printer.execute();
    res.sendStatus(200);
  }catch(e){
    console.error(e);
    res.sendStatus(500);
  }
});

app.listen(3000,()=>console.log("üñ®Ô∏è Impresi√≥n lista"));
